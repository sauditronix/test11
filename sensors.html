<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Sensor Lab - Full Duplex</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MQTT.js -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .log-window::-webkit-scrollbar { width: 8px; }
        .log-window::-webkit-scrollbar-track { background: #1f2937; }
        .log-window::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        
        /* Toggle Switch Styles */
        input:checked ~ .dot { transform: translateX(100%); }
        input:checked ~ .block { background-color: #10B981; }
        
        /* Flash animation for received updates */
        @keyframes flash-green {
            0% { background-color: rgba(16, 185, 129, 0.5); }
            100% { background-color: transparent; }
        }
        .update-flash {
            animation: flash-green 1s ease-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans flex flex-col">

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fa-solid fa-tower-broadcast text-blue-500 text-2xl"></i>
                <div>
                    <h1 class="text-xl font-bold leading-tight">IoT Lab Simulator</h1>
                    <p class="text-[10px] text-gray-400 uppercase tracking-wide">Pub/Sub Edition</p>
                </div>
            </div>
            
            <div id="connection-status" class="flex items-center space-x-2 px-3 py-1 rounded-full bg-red-900/30 border border-red-500/50 transition-colors duration-300">
                <div id="status-dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                <span id="status-text" class="text-xs font-bold text-red-400 uppercase">Offline</span>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 flex-grow space-y-6">

        <!-- Configuration Panel -->
        <div class="bg-gray-800 rounded-xl p-5 shadow-lg border border-gray-700">
            <div class="flex justify-between items-center mb-4 cursor-pointer select-none" onclick="toggleSettings()">
                <h2 class="text-md font-bold text-gray-300 flex items-center gap-2">
                    <i class="fa-solid fa-sliders"></i> Lab Configuration
                </h2>
                <i id="settings-chevron" class="fa-solid fa-chevron-up text-gray-500"></i>
            </div>
            
            <div id="settings-panel" class="grid grid-cols-1 md:grid-cols-12 gap-4 transition-all duration-300">
                
                <!-- Broker URL -->
                <div class="md:col-span-4">
                    <label class="block text-[10px] uppercase text-gray-500 font-bold mb-1">Broker Host (WebSocket)</label>
                    <div class="relative">
                        <i class="fa-solid fa-globe absolute left-3 top-3 text-gray-500 text-xs"></i>
                        <input type="text" id="broker-host" value="wss://broker.emqx.io:8084/mqtt" 
                            class="w-full bg-gray-700 border border-gray-600 rounded pl-8 pr-3 py-2 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none font-mono text-gray-300 placeholder-gray-500">
                    </div>
                </div>

                <!-- Trainee ID -->
                <div class="md:col-span-3">
                    <label class="block text-[10px] uppercase text-green-400 font-bold mb-1">Trainee Name / ID</label>
                    <div class="relative">
                        <i class="fa-solid fa-user-tag absolute left-3 top-3 text-green-500 text-xs"></i>
                        <input type="text" id="trainee-id" placeholder="e.g. Student1" oninput="updateTopics()"
                            class="w-full bg-gray-700 border border-green-600/50 rounded pl-8 pr-3 py-2 text-sm focus:border-green-400 outline-none font-bold text-white">
                    </div>
                </div>

                <!-- Auto Interval Setting -->
                <div class="md:col-span-2">
                    <label class="block text-[10px] uppercase text-blue-400 font-bold mb-1">Auto Interval (Sec)</label>
                    <div class="relative">
                        <i class="fa-solid fa-clock absolute left-3 top-3 text-blue-500 text-xs"></i>
                        <input type="number" id="auto-interval" value="3" min="1" max="60"
                            class="w-full bg-gray-700 border border-blue-600/50 rounded pl-8 pr-3 py-2 text-sm focus:border-blue-400 outline-none font-bold text-white text-center">
                    </div>
                </div>

                <!-- Connect Button -->
                <div class="md:col-span-3 flex items-end">
                    <button id="connect-btn" onclick="toggleConnection()" 
                        class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded transition-all shadow-lg shadow-blue-900/50 flex justify-center items-center gap-2">
                        <i class="fa-solid fa-plug"></i> Connect
                    </button>
                </div>
            </div>
        </div>

        <!-- Sensors Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- Temperature Card -->
            <div id="card-temp" class="bg-gray-800 rounded-xl border border-gray-700 shadow-xl overflow-hidden flex flex-col transition-colors duration-500">
                <div class="bg-gradient-to-r from-orange-900/50 to-gray-800 p-4 border-b border-gray-700 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="bg-orange-500/20 p-2 rounded text-orange-400"><i class="fa-solid fa-temperature-half"></i></div>
                        <h3 class="font-bold text-gray-200">Temperature</h3>
                    </div>
                    <!-- Auto Toggle -->
                    <label class="flex items-center cursor-pointer" title="Sends data automatically based on interval">
                        <div class="relative">
                            <input id="temp-auto" type="checkbox" class="sr-only" onchange="toggleAuto('temp')">
                            <div class="block bg-gray-700 w-8 h-5 rounded-full border border-gray-600"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-3 h-3 rounded-full transition"></div>
                        </div>
                        <span class="ml-2 text-[10px] font-bold text-gray-400 uppercase">Auto</span>
                    </label>
                </div>
                
                <div class="p-5 flex-grow flex flex-col justify-between space-y-4">
                    <div class="text-center relative">
                         <!-- Indicator for incoming data -->
                         <div id="temp-indicator" class="hidden absolute top-0 right-0 text-green-500 text-xs animate-bounce"><i class="fa-solid fa-download"></i> Recv</div>
                        <span class="text-5xl font-mono font-bold text-orange-400 tracking-tighter"><span id="temp-display">24.5</span><span class="text-2xl text-gray-500 ml-1">Â°C</span></span>
                    </div>
                    <input type="range" id="temp-slider" min="-10" max="60" step="0.5" value="24.5" 
                        class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-orange-500" 
                        oninput="updateDisplay('temp', this.value)">
                    
                    <div>
                        <label class="text-[10px] uppercase text-gray-500 font-bold">Topic</label>
                        <input type="text" id="temp-topic" readonly class="w-full bg-gray-900/50 text-gray-400 text-xs font-mono border border-gray-700 rounded px-2 py-1 mb-2 focus:outline-none cursor-not-allowed">
                        
                        <button onclick="publishManual('temp')" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-200 font-medium py-2 rounded transition-colors flex justify-center items-center gap-2 text-sm border border-gray-600">
                            <i class="fa-regular fa-paper-plane"></i> Publish Payload
                        </button>
                    </div>
                </div>
            </div>

            <!-- Humidity Card -->
            <div id="card-hum" class="bg-gray-800 rounded-xl border border-gray-700 shadow-xl overflow-hidden flex flex-col transition-colors duration-500">
                <div class="bg-gradient-to-r from-blue-900/50 to-gray-800 p-4 border-b border-gray-700 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-500/20 p-2 rounded text-blue-400"><i class="fa-solid fa-droplet"></i></div>
                        <h3 class="font-bold text-gray-200">Humidity</h3>
                    </div>
                    <label class="flex items-center cursor-pointer" title="Sends data automatically based on interval">
                        <div class="relative">
                            <input id="hum-auto" type="checkbox" class="sr-only" onchange="toggleAuto('hum')">
                            <div class="block bg-gray-700 w-8 h-5 rounded-full border border-gray-600"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-3 h-3 rounded-full transition"></div>
                        </div>
                        <span class="ml-2 text-[10px] font-bold text-gray-400 uppercase">Auto</span>
                    </label>
                </div>
                
                <div class="p-5 flex-grow flex flex-col justify-between space-y-4">
                    <div class="text-center relative">
                        <div id="hum-indicator" class="hidden absolute top-0 right-0 text-green-500 text-xs animate-bounce"><i class="fa-solid fa-download"></i> Recv</div>
                        <span class="text-5xl font-mono font-bold text-blue-400 tracking-tighter"><span id="hum-display">45</span><span class="text-2xl text-gray-500 ml-1">%</span></span>
                    </div>
                    <input type="range" id="hum-slider" min="0" max="100" step="1" value="45" 
                        class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500" 
                        oninput="updateDisplay('hum', this.value)">
                    
                    <div>
                        <label class="text-[10px] uppercase text-gray-500 font-bold">Topic</label>
                        <input type="text" id="hum-topic" readonly class="w-full bg-gray-900/50 text-gray-400 text-xs font-mono border border-gray-700 rounded px-2 py-1 mb-2 focus:outline-none cursor-not-allowed">
                        
                        <button onclick="publishManual('hum')" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-200 font-medium py-2 rounded transition-colors flex justify-center items-center gap-2 text-sm border border-gray-600">
                            <i class="fa-regular fa-paper-plane"></i> Publish Payload
                        </button>
                    </div>
                </div>
            </div>

            <!-- Door Sensor Card -->
            <div id="card-door" class="bg-gray-800 rounded-xl border border-gray-700 shadow-xl overflow-hidden flex flex-col transition-colors duration-500">
                <div class="bg-gradient-to-r from-purple-900/50 to-gray-800 p-4 border-b border-gray-700 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="bg-purple-500/20 p-2 rounded text-purple-400"><i class="fa-solid fa-door-open"></i></div>
                        <h3 class="font-bold text-gray-200">Door Contact</h3>
                    </div>
                    <label class="flex items-center cursor-pointer" title="Sends data automatically based on interval">
                        <div class="relative">
                            <input id="door-auto" type="checkbox" class="sr-only" onchange="toggleAuto('door')">
                            <div class="block bg-gray-700 w-8 h-5 rounded-full border border-gray-600"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-3 h-3 rounded-full transition"></div>
                        </div>
                        <span class="ml-2 text-[10px] font-bold text-gray-400 uppercase">Auto</span>
                    </label>
                </div>
                
                <div class="p-5 flex-grow flex flex-col justify-between space-y-4">
                    <div class="flex justify-center py-2 relative">
                        <div id="door-indicator" class="hidden absolute top-0 right-0 text-green-500 text-xs animate-bounce"><i class="fa-solid fa-download"></i> Recv</div>
                        <button id="door-btn" onclick="toggleDoor()" class="group relative w-24 h-24 rounded-full bg-gray-700 border-4 border-green-500 shadow-[0_0_20px_rgba(34,197,94,0.3)] transition-all duration-300">
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <i id="door-icon" class="fa-solid fa-door-closed text-3xl text-gray-200 mb-1 transition-transform group-hover:scale-110"></i>
                                <span id="door-text" class="text-[10px] font-bold uppercase text-green-400">Closed</span>
                            </div>
                        </button>
                        <input type="hidden" id="door-value" value="CLOSED">
                    </div>
                    
                    <div>
                        <label class="text-[10px] uppercase text-gray-500 font-bold">Topic</label>
                        <input type="text" id="door-topic" readonly class="w-full bg-gray-900/50 text-gray-400 text-xs font-mono border border-gray-700 rounded px-2 py-1 mb-2 focus:outline-none cursor-not-allowed">
                        
                        <button onclick="publishManual('door')" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-200 font-medium py-2 rounded transition-colors flex justify-center items-center gap-2 text-sm border border-gray-600">
                            <i class="fa-regular fa-paper-plane"></i> Publish Payload
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Terminal Log -->
        <div class="flex-grow flex flex-col min-h-[200px]">
            <div class="bg-gray-800 rounded-t-xl border border-gray-700 p-2 flex justify-between items-center">
                <div class="flex space-x-2">
                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                    <span class="text-xs font-mono text-gray-400 ml-2">Console Output</span>
                </div>
                <button onclick="clearLog()" class="text-xs text-gray-500 hover:text-white hover:underline">Clear Log</button>
            </div>
            <div id="console-output" class="log-window flex-grow bg-black/80 font-mono text-xs p-4 overflow-y-auto border-x border-b border-gray-700 rounded-b-xl shadow-inner text-gray-300">
                <div class="text-blue-400 opacity-80 mb-1">> System Ready. Enter your Trainee ID above.</div>
            </div>
        </div>

    </main>

    <script>
        // --- State Management ---
        let client = null;
        let isConnected = false;
        let clientId = "web_" + Math.random().toString(16).substr(2, 8);
        
        const intervals = { temp: null, hum: null, door: null };

        // --- Initialization ---
        window.onload = function() {
            const randomSuffix = Math.floor(Math.random() * 100);
            document.getElementById('trainee-id').value = "Trainee" + randomSuffix;
            updateTopics();
        };

        // --- Core Logic: Update Topics Based on Trainee Name ---
        function updateTopics() {
            const rawId = document.getElementById('trainee-id').value;
            const safeId = rawId.trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '') || "Anonymous";
            
            document.getElementById('temp-topic').value = `lab/${safeId}/temp`;
            document.getElementById('hum-topic').value  = `lab/${safeId}/humidity`;
            document.getElementById('door-topic').value = `lab/${safeId}/door`;
        }

        // --- Connection Logic ---
        function toggleConnection() {
            if (isConnected) disconnect();
            else connect();
        }

        function connect() {
            const host = document.getElementById('broker-host').value;
            const btn = document.getElementById('connect-btn');
            const traineeId = document.getElementById('trainee-id').value;

            if(traineeId.trim() === "") {
                log("Error: Please enter a Trainee Name/ID before connecting.", "error");
                document.getElementById('trainee-id').focus();
                return;
            }

            log(`Connecting to ${host}...`);
            updateStatus('connecting');

            try {
                // MQTT.js Connection
                client = mqtt.connect(host, {
                    clientId: clientId, 
                    clean: true,
                    connectTimeout: 4000,
                });

                client.on('connect', () => {
                    isConnected = true;
                    log(`Connected! Client ID: ${clientId}`, 'success');
                    updateStatus('connected');
                    
                    // UI Updates
                    btn.innerHTML = `<i class="fa-solid fa-power-off"></i> Disconnect`;
                    btn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
                    btn.classList.add('bg-red-600', 'hover:bg-red-500');
                    
                    document.getElementById('trainee-id').disabled = true;
                    document.getElementById('trainee-id').classList.add('opacity-50', 'cursor-not-allowed');
                    document.getElementById('settings-panel').classList.add('hidden');
                    document.getElementById('settings-chevron').classList.replace('fa-chevron-up', 'fa-chevron-down');

                    // **SUBSCRIBE TO TOPICS**
                    subscribeToSensors();
                });

                // **HANDLE INCOMING MESSAGES**
                client.on('message', (topic, message) => {
                    handleMessage(topic, message);
                });

                client.on('error', (err) => {
                    log(`Connection Error: ${err.message}`, 'error');
                    updateStatus('error');
                    disconnect(); 
                });
                
                client.on('offline', () => {
                   if(isConnected) log("Connection lost.", "warning"); 
                });

            } catch (e) {
                log(`Config Error: ${e.message}`, 'error');
                updateStatus('error');
            }
        }

        function subscribeToSensors() {
            const tTemp = document.getElementById('temp-topic').value;
            const tHum = document.getElementById('hum-topic').value;
            const tDoor = document.getElementById('door-topic').value;
            
            const topics = [tTemp, tHum, tDoor];
            
            client.subscribe(topics, (err) => {
                if(!err) {
                    log(`Subscribed to: ${topics.join(', ')}`, 'info');
                } else {
                    log(`Subscription failed: ${err.message}`, 'error');
                }
            });
        }

        function handleMessage(topic, message) {
            // Get current target topics (trimmed to be safe against hidden spaces)
            const tTemp = document.getElementById('temp-topic').value.trim();
            const tHum = document.getElementById('hum-topic').value.trim();
            const tDoor = document.getElementById('door-topic').value.trim();
            
            // Normalize inputs
            const topicStr = topic.toString().trim();
            const msgStr = message.toString();
            
            log(`[RECV] ${topicStr}: ${msgStr}`, 'in');

            try {
                const data = JSON.parse(msgStr);
                
                // --- Temperature Logic ---
                if (topicStr === tTemp) {
                    // Try to get value, fallback to raw number if user sent that
                    let val = (data.value !== undefined) ? data.value : (typeof data === 'number' ? data : undefined);
                    
                    if (val !== undefined) {
                        document.getElementById('temp-slider').value = val;
                        document.getElementById('temp-display').innerText = val;
                        highlightUpdate('temp');
                    } else {
                        log(`Warning: JSON missing 'value' key`, 'warning');
                    }
                } 
                // --- Humidity Logic ---
                else if (topicStr === tHum) {
                    let val = (data.value !== undefined) ? data.value : (typeof data === 'number' ? data : undefined);
                    
                    if (val !== undefined) {
                        document.getElementById('hum-slider').value = val;
                        document.getElementById('hum-display').innerText = val;
                        highlightUpdate('hum');
                    }
                } 
                // --- Door Logic ---
                else if (topicStr === tDoor) {
                    const status = data.status || (data.value !== undefined ? data.value : undefined);
                    if (status !== undefined) {
                        setDoorUI(status);
                        highlightUpdate('door');
                    }
                }
            } catch (e) {
                log(`Failed to parse JSON: ${e.message}`, 'warning');
            }
        }

        function highlightUpdate(type) {
            // Visual feedback that data came from outside (or loopback)
            const ind = document.getElementById(`${type}-indicator`);
            if(ind) {
                ind.classList.remove('hidden');
                setTimeout(() => ind.classList.add('hidden'), 1000);
            }
            
            // Flash card border
            const card = document.getElementById(`card-${type}`);
            if(card) {
                card.classList.add('border-green-500');
                setTimeout(() => card.classList.remove('border-green-500'), 500);
            }
        }

        function disconnect() {
            if (client) { client.end(); client = null; }
            
            // Stop auto-publishers
            ['temp', 'hum', 'door'].forEach(t => {
                if(document.getElementById(`${t}-auto`).checked) document.getElementById(`${t}-auto`).click();
            });

            isConnected = false;
            updateStatus('disconnected');
            log('Disconnected from broker.', 'warning');
            
            const btn = document.getElementById('connect-btn');
            btn.innerHTML = `<i class="fa-solid fa-plug"></i> Connect`;
            btn.classList.add('bg-blue-600', 'hover:bg-blue-500');
            btn.classList.remove('bg-red-600', 'hover:bg-red-500');
            
            document.getElementById('trainee-id').disabled = false;
            document.getElementById('trainee-id').classList.remove('opacity-50', 'cursor-not-allowed');
        }

        // --- Data Publishing ---
        function publishManual(type) {
            if (!isConnected) {
                log('Cannot send: Not connected.', 'error');
                return;
            }

            const topic = document.getElementById(`${type}-topic`).value;
            let payload = {};
            const timestamp = new Date().toISOString();
            const trainee = document.getElementById('trainee-id').value.trim();

            if (type === 'temp') {
                const val = parseFloat(document.getElementById('temp-slider').value);
                payload = { trainee: trainee, sensor: "temp_01", type: "temperature", value: val, unit: "C", ts: timestamp };
            } else if (type === 'hum') {
                const val = parseInt(document.getElementById('hum-slider').value);
                payload = { trainee: trainee, sensor: "hum_01", type: "humidity", value: val, unit: "%", ts: timestamp };
            } else if (type === 'door') {
                const val = document.getElementById('door-value').value;
                payload = { trainee: trainee, sensor: "door_main", type: "door", status: val, ts: timestamp };
            }

            const jsonString = JSON.stringify(payload);
            
            client.publish(topic, jsonString, { qos: 0, retain: false }, (err) => {
                if (err) log(`Publish Failed: ${err}`, 'error');
                else log(`[SEND] ${topic}: ${jsonString}`, 'out');
            });
        }

        // --- UI & Interactions ---
        function updateDisplay(type, val) {
            // Only update text locally, don't publish yet (publish is via button or auto)
            document.getElementById(`${type}-display`).innerText = val;
        }

        function toggleDoor() {
            // This function creates the user intent to change the door
            // It updates the hidden value, then calls publish, which goes to broker,
            // comes back via subscription, and THEN calls setDoorUI to visually flip it.
            // For smoother UX, we can flip locally immediately, but waiting for msg proves connection.
            // Let's flip locally for responsiveness, loopback will just confirm it.
            
            const valInput = document.getElementById('door-value');
            const newState = (valInput.value === 'CLOSED') ? 'OPEN' : 'CLOSED';
            valInput.value = newState;
            
            // We do NOT update the UI icon here if we want to rely purely on MQTT loopback
            // But to avoid confusion if disconnected, we usually update UI. 
            // In this "Full Duplex" mode, let's update UI to show intent, then publish.
            setDoorUI(newState);
            
            // Actually, if we are in manual mode, user clicks button -> toggles value -> then clicks "Send".
            // If the user clicks the big door button, they expect it to change state.
        }
        
        function setDoorUI(state) {
            const btn = document.getElementById('door-btn');
            const icon = document.getElementById('door-icon');
            const txt = document.getElementById('door-text');
            const valInput = document.getElementById('door-value');
            
            valInput.value = state; // Ensure input matches
            
            if (state === 'OPEN') {
                txt.innerText = 'Open';
                txt.classList.replace('text-green-400', 'text-red-400');
                btn.classList.replace('border-green-500', 'border-red-500');
                btn.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.3)';
                icon.classList.replace('fa-door-closed', 'fa-door-open');
                icon.classList.remove('text-gray-200');
                icon.classList.add('text-red-200');
            } else {
                txt.innerText = 'Closed';
                txt.classList.replace('text-red-400', 'text-green-400');
                btn.classList.replace('border-red-500', 'border-green-500');
                btn.style.boxShadow = '0 0 20px rgba(34, 197, 94, 0.3)';
                icon.classList.replace('fa-door-open', 'fa-door-closed');
                icon.classList.remove('text-red-200');
                icon.classList.add('text-gray-200');
            }
        }

        function toggleSettings() {
            document.getElementById('settings-panel').classList.toggle('hidden');
            const chev = document.getElementById('settings-chevron');
            if(chev.classList.contains('fa-chevron-up')) chev.classList.replace('fa-chevron-up', 'fa-chevron-down');
            else chev.classList.replace('fa-chevron-down', 'fa-chevron-up');
        }

        // --- Auto Simulation ---
        function toggleAuto(type) {
            const chk = document.getElementById(`${type}-auto`);
            
            if (!isConnected && chk.checked) {
                log("Connect first to enable Auto-Mode.", "warning");
                chk.checked = false;
                return;
            }

            if (chk.checked) {
                let intervalSec = document.getElementById('auto-interval').value;
                if(intervalSec < 1) { intervalSec = 1; document.getElementById('auto-interval').value = 1; }
                const ms = intervalSec * 1000;

                log(`Starting auto-stream for ${type} (Every ${intervalSec}s)...`, 'info');
                intervals[type] = setInterval(() => simulate(type), ms);
            } else {
                log(`Stopping auto-stream for ${type}.`, 'info');
                clearInterval(intervals[type]);
            }
        }

        function simulate(type) {
            if(type === 'temp') {
                const current = parseFloat(document.getElementById('temp-slider').value);
                let next = current + (Math.random() > 0.5 ? 0.5 : -0.5);
                if(next > 60) next = 60; if(next < -10) next = -10;
                
                // Update UI Immediately
                let nextFixed = next.toFixed(1);
                document.getElementById('temp-slider').value = nextFixed;
                updateDisplay('temp', nextFixed);

            } else if (type === 'hum') {
                const current = parseInt(document.getElementById('hum-slider').value);
                let next = current + (Math.random() > 0.5 ? 2 : -2);
                if(next > 100) next = 100; if(next < 0) next = 0;
                
                // Update UI Immediately
                document.getElementById('hum-slider').value = next;
                updateDisplay('hum', next);

            } else if (type === 'door') {
                if(Math.random() > 0.85) {
                   const valInput = document.getElementById('door-value');
                   const newState = (valInput.value === 'CLOSED') ? 'OPEN' : 'CLOSED';
                   
                   // Update UI Immediately
                   setDoorUI(newState);
                }
            }
            publishManual(type);
        }

        // --- Helpers ---
        function log(msg, type='normal') {
            const box = document.getElementById('console-output');
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString('en-US', {hour12:false});
            
            let colorClass = "text-gray-300";
            if(type === 'error') colorClass = "text-red-400 font-bold";
            else if(type === 'success') colorClass = "text-green-400 font-bold";
            else if(type === 'warning') colorClass = "text-yellow-400";
            else if(type === 'out') colorClass = "text-cyan-300";
            else if(type === 'in') colorClass = "text-purple-300"; // Incoming
            else if(type === 'info') colorClass = "text-gray-500 italic";
            
            div.innerHTML = `<span class="text-gray-600 select-none mr-2">[${time}]</span> <span class="${colorClass}">${msg}</span>`;
            
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function updateStatus(status) {
            const text = document.getElementById('status-text');
            const dot = document.getElementById('status-dot');
            const box = document.getElementById('connection-status');
            
            if(status === 'connected') {
                text.innerText = "Online"; text.className = "text-xs font-bold text-green-400 uppercase";
                dot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]";
                box.className = "flex items-center space-x-2 px-3 py-1 rounded-full bg-green-900/30 border border-green-500/50 transition-colors duration-300";
            } else if (status === 'connecting') {
                text.innerText = "Connecting"; text.className = "text-xs font-bold text-yellow-400 uppercase";
                dot.className = "w-2 h-2 rounded-full bg-yellow-500 animate-ping";
                box.className = "flex items-center space-x-2 px-3 py-1 rounded-full bg-yellow-900/30 border border-yellow-500/50 transition-colors duration-300";
            } else {
                text.innerText = "Offline"; text.className = "text-xs font-bold text-red-400 uppercase";
                dot.className = "w-2 h-2 rounded-full bg-red-500";
                box.className = "flex items-center space-x-2 px-3 py-1 rounded-full bg-red-900/30 border border-red-500/50 transition-colors duration-300";
            }
        }
    </script>
</body>
</html>